---
title: "Project Part 1"
author: "Sara Altman & Hershel Mehta"
date: "October 25, 2017"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
```

# Load Data

```{r}
df_trials <- read_csv("relapse_trials.csv")
df_subjects <- read_csv("relapse_subjects.csv")

df_subjid <- df_subjects %>% 
  select(subjid, relapse = relIn6Mos)
```

\pagebreak

# Exploratory Data Analysis

## Time Series (Relapse x Condition)

```{r}
df_trials %>% 
  left_join(df_subjid, by = c("subjects" = "subjid")) %>% 
  group_by(relapse, condition) %>% 
  summarise_at(vars(starts_with("TR"), -trial), mean) %>% 
  ungroup() %>% 
  slice(1:6) %>% 
  gather(key = "TR", value = "signal", TR3:TR6) %>% 
  ggplot(aes(x = TR, y = signal)) +
  geom_line(aes(group = relapse, color = factor(relapse))) +
  facet_wrap(~condition)
```

Some thoughts:

* Seems like relapsers have blunted brain activaiton across the board when compared within condition

* Notice that TR4 for drugs and food are decently stimulating for non-relapsers, but it looks like food is very blunted for relapsers. Perhaps a salient feature would be TR4 (drugs) - TR4 (food)!

* These appear to be different from Kelly's results from her poster, is it because our sample size has increased? Check with Kelly...

\pagebreak

## Density Plot of Betas (Relapse x Condition)

```{r}
df_subjects %>% 
  select(subjid, relapse = relIn6Mos, starts_with("nacc")) %>% 
  select(relapse, ends_with("beta")) %>% 
  gather(key = "condition", value = "signal", nacc_drugs_beta, nacc_food_beta, nacc_neutral_beta) %>% 
  ggplot(aes(x = signal, y = ..density.., color = factor(relapse), fill = factor(relapse))) + 
  geom_density(alpha = 0.2) +
  facet_wrap(~ condition)
```

This is a plot of the extracted coefficient for nacc_betas, which shows that relapsers should have a higher mean beta than non-relapsers... 

* Looks like nacc_drugs_beta captures some differentiating factor between relapsers and non-relapsers! Perhaps we should try a classification using the nacc_betas! 

* Do we need any kind of transformation here?

* We should find out what regression these coefficients are extracted from to help interpret...

\pagebreak

## TODOS

* Try k-fold subject-level classification of relapse in 6 months, using: 1) nacc_drugs_beta (extracted betas approach) and 2) TR4 (drugs) - TR4 (food) (raw activation approach)

* Try to find some behavioral metrics that also discrimnate relapsers from non-relapsers and establish, then do a k-fold cross-validated model to see how that compares with the predictive accuracy of our model using just brain activity

* Try to find a baseline model of predicting relapsers vs non-relapsers... Perhaps we could try something like a lasso model 
